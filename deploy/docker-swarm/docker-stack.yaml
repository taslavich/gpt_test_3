version: '3.8'

configs:
  nginx_conf:
    file: './nginx.conf'
  dsp_rules:
    file: '../../dsp_rules.json'
  spp_rules:
    file: '../../spp_rules.json'
  ssl_fullchain:
    file: './ssl-certs/fullchain.pem'
  ssl_privkey:
    file: './ssl-certs/privkey.pem'

volumes:
  redis_data:
  kafka_data:

services:
  nginx-gateway:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
      - "9092:9092"
      - "6379:6379"
      - "8080:8080"
      - "8081:8081"
      - "8082:8082"
      - "8084:8084"
      - "8085:8085"
    configs:
      - source: nginx_conf
        target: /etc/nginx/nginx.conf
      - source: ssl_fullchain
        target: /etc/ssl/fullchain.pem
      - source: ssl_privkey
        target: /etc/ssl/privkey.pem
    command: ["nginx", "-g", "daemon off;"]
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health || exit 0"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure

  redis:
    image: redis:7-alpine
    hostname: redis
    env_file:
      - env/redis.env
    command: ["sh", "-c", "redis-server --requirepass \"$${REDIS_PASSWORD}\""]
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "$${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  kafka:
    image: apache/kafka:3.7.0
    hostname: kafka
    env_file:
      - env/kafka.env
    volumes:
      - kafka_data:/tmp/kraft-combined-logs
    healthcheck:
      test: ["CMD", "kafka-topics.sh", "--list", "--bootstrap-server", "localhost:9092"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  orchestrator:
    image: ${ORCHESTRATOR_IMAGE:-localhost:5000/rtb/orchestrator:local}
    env_file:
      - env/orchestrator.env
      - env/redis.env
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 5

  bid-engine:
    image: ${BID_ENGINE_IMAGE:-localhost:5000/rtb/bid-engine:local}
    env_file:
      - env/bid-engine.env
      - env/redis.env
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 5

  router:
    image: ${ROUTER_IMAGE:-localhost:5000/rtb/router:local}
    env_file:
      - env/router.env
      - env/redis.env
    configs:
      - source: dsp_rules
        target: /dsp-rules.json
      - source: spp_rules
        target: /spp-rules.json
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 5

  spp-adapter:
    image: ${SPP_ADAPTER_IMAGE:-localhost:5000/rtb/spp-adapter:local}
    env_file:
      - env/spp-adapter.env
      - env/redis.env
    volumes:
      - ../../GeoIP2_City.mmdb:/GeoIP2_City.mmdb:ro
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 5

  kafka-loader:
    image: ${KAFKA_LOADER_IMAGE:-localhost:5000/rtb/kafka-loader:local}
    env_file:
      - env/kafka-loader.env
      - env/redis.env
    healthcheck:
      test: ["CMD", "pgrep", "-f", "kafka-loader"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      restart_policy:
        condition: on-failure

  clickhouse-loader:
    image: ${CLICKHOUSE_LOADER_IMAGE:-localhost:5000/rtb/clickhouse-loader:local}
    env_file:
      - env/clickhouse-loader.env
    healthcheck:
      test: ["CMD", "pgrep", "-f", "clickhouse-loader"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      restart_policy:
        condition: on-failure